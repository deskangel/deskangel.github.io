<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>DeskAngel</title>
  <meta name="author" content="William Hsueh">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="DeskAngel"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/deskangel.github.io/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/deskangel.github.io/css/themes/slate.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/deskangel.github.io/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/deskangel.github.io/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/deskangel.github.io/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/deskangel.github.io/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/deskangel.github.io/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/deskangel.github.io/css/comment.css" media="screen" type="text/css">
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-sham.min.js"></script>
  <![endif]-->

  <script src="/deskangel.github.io/js/jquery-2.0.3.min.js"></script>
  
  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar  navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/deskangel.github.io/">DeskAngel</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/deskangel.github.io/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/deskangel.github.io/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/deskangel.github.io/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/deskangel.github.io/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header ">
  <h1 class="title ">DIG DEEPER, DO DIFFERENT</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      dig deeper, do different
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
        <!-- render top articles firstly -->
        
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
        
        <!-- render other articles -->
        
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2020-04-20 </div>
			<div class="article-title"><a href="/deskangel.github.io/2020/04/20/dafileserver-dev-notes/" >DaFileShare 开发笔记</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>一直以来都觉得电脑分享文件到手机上比较麻烦，试过不少软件，不是收费很贵就是不太方便，至于通过 USB 线——感觉这个更不方便。每次通过微信，QQ 之类的 IM 传了文件之后，就想要开发一个简单的文件分享工具。</p>
<p>DaFileShare 的代码很简单，分成两个部分：</p>
<ul>
<li>Command line 的 http server 提供文件分享功能</li>
<li>Mac App 对其进行封装，提供拖放支持</li>
</ul>
<p>开发 DaFileShare 之前没有做过 Mac App 的开发，也没有接触过 Swift，一切都是新学，所以记一下Mac App的开发过程，以及遇到的问题，至于 Command line 部分，没有什么好讲的。</p>
<p>第一个遇到的问题就是<code>拖放</code>。</p>
<h3 id="拖放"><a href="#拖放" class="headerlink" title="拖放"></a>拖放</h3><p>Macos 的拖放是通过剪切板实现的，首先App需要注册拖放的类型。第一个纠结的问题是：在哪里注册？</p>
<p>参考了网上的文章和 Apple 的开发文档，NSView 提供了拖放的支持，但是还需要进行一些处理。经过测试，<code>awakFromNib</code> 是一个很好的入口，哪怕用的是<code>StoryBoard</code>，一样会进入这个函数。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">awakeFromNib</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.awakeFromNib()</div><div class="line">    <span class="keyword">self</span>.registerForDraggedTypes([<span class="type">NSPasteboard</span>.<span class="type">PasteboardType</span>.fileURL])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为新手的原因，不知道如何把 NSView 类和 StoryBoard，Google 了很久也没有任何发现，直到后来看到 <code>identity inspector</code> 下的 <code>Custom Class</code>，尝试着把 StoryBoard 中的 view 的类改为自己的类才算成功。</p>
<h4 id="获取拖放的数据"><a href="#获取拖放的数据" class="headerlink" title="获取拖放的数据"></a>获取拖放的数据</h4><p>可能是因为 Swift 的快速发展，网上一些文章已经过时，获取剪切板数据的方法在 Xcode 11.4.1 下已经失效了。下面是可以工作的代码：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">performDragOperation</span><span class="params">(<span class="number">_</span> sender: NSDraggingInfo)</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">    <span class="keyword">let</span> pboard = sender.draggingPasteboard</div><div class="line">    <span class="keyword">let</span> dragTypes = pboard.types! <span class="keyword">as</span> <span class="type">NSArray</span></div><div class="line">    <span class="keyword">if</span> dragTypes.<span class="built_in">contains</span>(<span class="type">NSPasteboard</span>.<span class="type">PasteboardType</span>.fileURL) &#123;</div><div class="line">        <span class="keyword">let</span> files = pboard.propertyList(forType: <span class="type">NSPasteboard</span>.<span class="type">PasteboardType</span>(rawValue: <span class="string">"NSFilenamesPboardType"</span>)) <span class="keyword">as</span>! [<span class="type">String</span>]</div><div class="line">        <span class="keyword">let</span> numberOfFiles = files.<span class="built_in">count</span></div><div class="line">        <span class="keyword">if</span> numberOfFiles &gt; <span class="number">0</span> &#123;</div><div class="line">            <span class="keyword">let</span> filePath = files[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">String</span></div><div class="line">            <span class="keyword">if</span> <span class="keyword">let</span> delegate = <span class="keyword">self</span>.delegate &#123;</div><div class="line">                <span class="type">NSLog</span>(<span class="string">"file path \(filePath)"</span>)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h3><p>第二个遇到的大问题是关闭：view 的关闭，窗口的关闭，App 的关闭。<br>由于想在退出 App 的时候进行一些处理，特别是 Command line 的 http server 进程的关闭，结果就遇到问题了。</p>
<h4 id="同步关闭"><a href="#同步关闭" class="headerlink" title="同步关闭"></a>同步关闭</h4><p>首先，点击窗口上的关闭按钮后，只是关闭了窗口，但是 App 没有退出。再次点击 Dock 上的 App 图标，也没有像其他应用一样再次打开窗口，而是没有任何反应。<br>因为我不需要再打开窗口，只需要同步关闭，这个比较好处理，在 <code>AppDelegate</code> 中加一个函数即可：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">applicationShouldTerminateAfterLastWindowClosed</span><span class="params">(<span class="number">_</span> sender: NSApplication)</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="不同的关闭方式"><a href="#不同的关闭方式" class="headerlink" title="不同的关闭方式"></a>不同的关闭方式</h4><p>然后，只需要找个地方同一处理关闭事件就好了吧？——然而并不是！<br>正常的关闭方式有三种：关闭按钮，菜单Quit，Cmd+Q。三种方式，三个表现形式！！</p>
<hr>
<h5 id="关闭按钮"><a href="#关闭按钮" class="headerlink" title="关闭按钮"></a>关闭按钮</h5><p>窗口上的关闭按钮可能是最正常的方式了。点击后，<code>ViewController</code> 的 <code>viewDidDisappear</code> 被调用，但是如果你在 <code>AppDelegate</code> 有写<br><code>applicationShouldTerminate</code> 函数，你会发现这个函数关闭没有调用到。</p>
<h5 id="菜单-Quit"><a href="#菜单-Quit" class="headerlink" title="菜单 Quit"></a>菜单 Quit</h5><p>通过菜单——不管是 Dock 上的菜单还是菜单栏上——的Quit，<code>applicationShouldTerminate</code> 被调用到了，但是，<code>viewDidDisappear</code> 没有调用。</p>
<h5 id="Cmd-Q"><a href="#Cmd-Q" class="headerlink" title="Cmd+Q"></a>Cmd+Q</h5><p>一句话，什么都不调用！！</p>
<hr>
<p>通过查阅资料，是因为在”macOS 10.6”中引入了一个叫做<code>Sudden Termination</code>的机制来快速关闭 App。由于刚开始接触 macos 开发，不想一开始就钻研太深，还是尽早把 App 实现才是正事，所以只看了如何关闭这个机制。没错，这个<code>Sudden Termination</code>可以关闭，只需要一行代码：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">applicationDidFinishLaunching</span><span class="params">(<span class="number">_</span> aNotification: Notification)</span></span> &#123;</div><div class="line">    <span class="comment">// Insert code here to initialize your application</span></div><div class="line">    <span class="type">ProcessInfo</span>.processInfo.disableSuddenTermination()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>至此，这三种关闭方式都会调用到<code>applicationShouldTerminate</code>和<code>viewDidDisappear</code>，选一个地方处理就可以。我是在<code>viewDidDisappear</code>中进行处理，因为主要的逻辑代码在<code>ViewController</code>中。</p>
<h5 id="异常关闭"><a href="#异常关闭" class="headerlink" title="异常关闭"></a>异常关闭</h5><p>异常关闭有两种：一种是程序出现 Exception 导致退出的，一种是被 kill 掉。</p>
<p>根据 Windows 上的经验，第一种应该有一个全局处理比如“unCaughtException” 这样的函数来处理，但是我没有尝试；第二种应该是需要捕获 signal 来处理，我尝试了但是没有成功，于是为了省事，把 kill signal屏蔽掉了：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">applicationDidFinishLaunching</span><span class="params">(<span class="number">_</span> aNotification: Notification)</span></span> &#123;</div><div class="line">    <span class="comment">// Insert code here to initialize your application</span></div><div class="line">    <span class="type">ProcessInfo</span>.processInfo.disableSuddenTermination()</div><div class="line"></div><div class="line">    signal(<span class="type">SIGTERM</span>, <span class="type">SIG_IGN</span>) <span class="comment">// ignore the termination signal</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><p>Xcode 11.4.1，Swift 5，macos 10.15.4</p>
<h3 id="Download"><a href="#Download" class="headerlink" title="Download"></a>Download</h3><p>你可以下载 <a href="https://github.com/deskangel/deskangel.github.io/releases/download/19042020/DaFileShare.app.zip" target="_blank" rel="external">DaFileShare</a></p>

	
	</div>
  <a type="button" href="/deskangel.github.io/2020/04/20/dafileserver-dev-notes/#more" class="btn btn-default more">Read More</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-10-24 </div>
			<div class="article-title"><a href="/deskangel.github.io/2018/10/24/vsc-with-gdb-remote/" >vsc-with-gdb-remote</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		
	
	</div>
  <a type="button" href="/deskangel.github.io/2018/10/24/vsc-with-gdb-remote/#more" class="btn btn-default more">Read More</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-03-31 </div>
			<div class="article-title"><a href="/deskangel.github.io/2018/03/31/build-eos-on-ubuntu-16-04/" >Build EOS on ubuntu 16.04</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>为了和官方测试链对接，选择的是<code>dawn-2.x</code>分支。官方推荐的是在<code>Ubuntu 16.10</code>上面编译，但是我只有16.04，想来应该是差不多的。</p>
<p>参考<a href="https://github.com/EOSIO/eos/blob/DAWN-2018-02-14/README.md" target="_blank" rel="external">官方文档</a>，直接开干。</p>
<h4 id="第一个坑"><a href="#第一个坑" class="headerlink" title="第一个坑"></a>第一个坑</h4><p>第一个坑其实是关于git的，具体一点就是关于git的子模块的。如果在命令行checkout dawn-2.x分支，一定不要忘了在子模块不会自动切换分支。而且，手动切换后，也会留下一堆<code>Untracked files</code>，我是直接没管。</p>
<h4 id="第二个坑"><a href="#第二个坑" class="headerlink" title="第二个坑"></a>第二个坑</h4><p>一开始自然是使用自动编译脚本<code>./build.sh ubuntu</code>。前面的下载和配置都没有报错，直到编译的时候，提示找不到<code>clang</code>，而且是<code>opt/wasm/bin/</code>下找不到。这好办，找到<code>/usr/bin/clang-4.0</code>，在<code>opt/wasm/bin/</code>下创建个链接就好</p>
<h4 id="第三个坑"><a href="#第三个坑" class="headerlink" title="第三个坑"></a>第三个坑</h4><p>然后<code>make -j4</code>，还是提示错误，仔细一看，是<code>binaryen</code>没有。处理第一个坑的时候，明明看到<code>binaryen</code>明晃晃的躺在<code>opt/</code>目录下，怎么没有了？进去一看，居然是空的！！</p>
<p>把<a href="https://github.com/EOSIO/eos/blob/DAWN-2018-02-14/README.md#ubuntu" target="_blank" rel="external">官方文档</a>翻到手动编译部分，找到<code>binaryen</code>的github地址，开始clone，只是速度非常慢。过了一段时间，一看已经失败了。提示错误信息：</p>
<blockquote>
<blockquote>
<p>error: RPC failed; curl 18 transfer closed with outstanding read data remaining<br>fatal: The remote end hung up unexpectedly<br>fatal: early EOF</p>
</blockquote>
</blockquote>
<p>Google之后，网友们会告诉你，这是缓存不够的原因。设置下git的配置 <code>git config --global http.postBuffer 524288000</code>，把缓存加大。而我修改了这个设置之后，又设置了http代理，几秒钟就把代码拉下来了。</p>
<p>大概也就遇到了这两个问题，应该说还算是比较顺利的。文档上说要下载<code>secp256k1-zkp</code>，然后我找了下，自动化脚本应该没有下载，而我也没有手动去下，并没有影响到编译和运行。</p>

	
	</div>
  <a type="button" href="/deskangel.github.io/2018/03/31/build-eos-on-ubuntu-16-04/#more" class="btn btn-default more">Read More</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-21 </div>
			<div class="article-title"><a href="/deskangel.github.io/2017/09/21/custom-eui-control-in-egret/" >custom-eui-control-in-egret</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>如何创建一个 eui 的控件，在 egret 的文档中是比较零散的，而且有些东西也没有讲到。这里提供一个比较完整的范例。</p>
<ol>
<li>创建一个 exml 文件，用来定义控件的显示元素，这里要注意的<code>classname</code> 的设置，比如设置成 <code>game.CustomButton</code>。game 为模块名（文档上也称呼为命名空间），后面需要用到。</li>
<li><p>创建一个 ts 文件，用来处理控件的逻辑。这个 ts 文件里面需要有模块，比如：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">module</span> game &#123;</div><div class="line"></div><div class="line">    <span class="keyword">export</span> <span class="keyword">class</span> CustomButton <span class="keyword">extends</span> eui.Button &#123;</div><div class="line">        <span class="keyword">public</span> rtQuality: eui.Rect;</div><div class="line"></div><div class="line">        <span class="keyword">constructor</span>(<span class="params"></span>) &#123;</div><div class="line">            <span class="keyword">super</span>();</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.skinName = <span class="string">"resource/skins/custom/EquipButtonSkin.exml"</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">set</span> quality(color: <span class="built_in">number</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.rtQuality) &#123;</div><div class="line">                <span class="keyword">this</span>.rtQuality.strokeColor = color;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">let</span> label = <span class="keyword">this</span>.labelDisplay <span class="keyword">as</span> eui.Label;</div><div class="line">            label.textColor = color;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">get</span> quality(): <span class="built_in">number</span> &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.rtQuality) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.rtQuality.strokeColor;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="number">0x444444</span>;</div><div class="line">        &#125;      </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在其他皮肤中使用的时候，可以从组件列表（COMPONENT/Custom)中直接拖动控件来使用，在 wing 4.03 版本中需要修改一下<code>Category Properties</code>中的 Skin，这应该是 wing 的一个 bug。</p>
</li>
<li>看一下 exml 的 Source，会发现添加了两个东西。一个是根节点的 <code>&lt;e:Skin ......... xmlns:game=&quot;game.*&quot; &gt;</code>；另一个是添加的控件的 tag 是 <code>&lt;game:CustomButton .....&gt;</code><br>关于这一点，可以<a href="http://developer.egret.com/cn/github/egret-docs/extension/EUI/advancedSkills/useComponents/index.html" target="_blank" rel="external">参考文档</a>。</li>
<li>在 ts 文件中使用的时候和普通的按钮一样，只是类型需要设置成 <code>game.CustomButton</code>。 </li>
</ol>

	
	</div>
  <a type="button" href="/deskangel.github.io/2017/09/21/custom-eui-control-in-egret/#more" class="btn btn-default more">Read More</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-09-30 </div>
			<div class="article-title"><a href="/deskangel.github.io/2016/09/30/ledongli-login-issue-workaround/" >乐动力“网络不给力”问题的处理</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>MX5上的乐动力 App 很早以前就不能登录了，各种途径都是提示“网络不给力”，等了大半年看他们是否会修正这个问题，但是每次版本更新后都试了，问题依旧存在。而且，无论是官网还是 App或是微博客服，都没有提供相关的说明该如何操作。<br>为了不丢失数据，只好自己动手了。</p>
<p>进入 Flyme 5 的访客系统，安装微信和乐动力 App，测试登录正常，之前的数据也能正常同步下来。</p>
<h4 id="第一步，祭出-Charles-看看都干了啥"><a href="#第一步，祭出-Charles-看看都干了啥" class="headerlink" title="第一步，祭出 Charles 看看都干了啥"></a>第一步，祭出 Charles 看看都干了啥</h4><p>启动 Charles，然后在手机上设置代理，进行登录，发现一个正常的登录主要做了几个操作：</p>
<ol>
<li>adduser，发送一个 pc 串，返回一个临时的 id</li>
<li>authbywechat，登录请求，url参数 uid 为之前请求的临时 id，返回用户 id</li>
<li>getinfo，获得用户相关信息，包括头像 url</li>
<li>updatewechatinfo，更新数据</li>
<li>updateinfo，更新数据</li>
</ol>
<h4 id="第二步，进入正常的系统，看看无法登录的版本都做了些什么"><a href="#第二步，进入正常的系统，看看无法登录的版本都做了些什么" class="headerlink" title="第二步，进入正常的系统，看看无法登录的版本都做了些什么"></a>第二步，进入正常的系统，看看无法登录的版本都做了些什么</h4><ol>
<li>authbywechat，url参数 uid 为<strong>残留的用户 id</strong>，返回 {“errorCode”: -10001, “ret”: “auth fail”}</li>
</ol>
<p>返回错误后就没有后续请求了。</p>
<p>现在看来就是验证的时候的 uid 的问题。查看反编译后的代码的时候发现，登录成功后这个 uid 是会被覆盖的。这样的话，给 App 一些正常的数据，让他先登录成功一次，以后理论上就不会有问题了。</p>
<p>如果是 root 的设备，直接把 SharedPreferences 中的 uid 的值改为0，App 就会进入 adduser 的流程，这样会比较简单。我不想 root 这个设备，所以写了些代码来模拟登录的流程。</p>
<h4 id="第三部，拦截请求，修改数据"><a href="#第三部，拦截请求，修改数据" class="headerlink" title="第三部，拦截请求，修改数据"></a>第三部，拦截请求，修改数据</h4><p>把正常登录的数据保存下来，在拦截到请求后把这些数据返回给 App。可能这部分也可以在 Charles 中完成，不过我修改了 hosts 文件，然后直接写了些 php 代码：<br>hosts 文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 walk.ledongli.cn</div></pre></td></tr></table></figure></p>
<p>路由部分：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Route::post(<span class="string">'/v2/rest/users/authbywechat'</span>, <span class="string">'MsgController@handleAuthWeChat'</span>);</div><div class="line">Route::post(<span class="string">'/v2/rest/users/getinfo'</span>, <span class="string">'MsgController@handleGetInfo'</span>);</div><div class="line">Route::post(<span class="string">'/v2/rest/users/updatewechatinfo'</span>, <span class="string">'MsgController@handleUpdateWeChatInfo'</span>);</div><div class="line">Route::post(<span class="string">'/v2/rest/users/updateinfo'</span>, <span class="string">'MsgController@handleUpdateInfo'</span>);</div></pre></td></tr></table></figure></p>
<p>响应部分(uid 和部分返回值删除了）：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleUpdateWeChatInfo</span><span class="params">(Request $request)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> response()-&gt;json([<span class="string">"errorCode"</span> =&gt; <span class="number">0</span>, <span class="string">"ret"</span> =&gt; <span class="keyword">null</span>]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleUpdateInfo</span><span class="params">(Request $request)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> response()-&gt;json([<span class="string">"errorCode"</span> =&gt; <span class="number">0</span>, <span class="string">"ret"</span> =&gt; <span class="keyword">null</span>]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleAuthWeChat</span><span class="params">(Request $request)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> response()-&gt;json([<span class="string">"errorCode"</span> =&gt; <span class="number">0</span>, <span class="string">"ret"</span> =&gt; [<span class="string">"uid"</span> =&gt; xxxxxxxxxx]]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleGetInfo</span><span class="params">(Request $request)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> response()-&gt;json([<span class="string">"errorCode"</span> =&gt; <span class="number">0</span>, <span class="string">"ret"</span> =&gt; [<span class="string">"target"</span> =&gt; , <span class="string">"weight"</span> =&gt; <span class="string">""</span>, <span class="string">"gender"</span> =&gt; <span class="string">"m"</span>, <span class="string">"checkined"</span> =&gt; , <span class="string">"checkin_mcount"</span> =&gt; , <span class="string">"birthdate"</span> =&gt; <span class="string">""</span>, <span class="string">"height"</span> =&gt; <span class="string">""</span>, <span class="string">"is_wechat"</span> =&gt; <span class="keyword">true</span>, <span class="string">"avatar"</span> =&gt; <span class="string">""</span>, <span class="string">"is_qq"</span> =&gt; <span class="keyword">false</span>, <span class="string">"is_sina"</span> =&gt; <span class="keyword">false</span>, <span class="string">"nickname"</span> =&gt; <span class="string">""</span>, <span class="string">"email"</span> =&gt; <span class="string">""</span>, <span class="string">"is_email"</span> =&gt; <span class="keyword">false</span>]]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>登录进入 App 之后，把 hosts 文件还原，去掉手机上 wifi 的代理，再在 App 中点击<code>立即备份数据</code>，可以看到开始正常备份了。</p>
<h4 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h4><ul>
<li>之所以出现这个问题，是因为残留的 uid 去请求登录的时候会导致失败。可能的原因大概是某一个版本的登录逻辑改变了，但是没有处理好老版本的兼容性。其实哪怕多加一个按钮能重置一下用于登录的临时 id 也好啊。</li>
<li>同步的时候也出现了问题，同步一两条数据后就会卡住不动，不会自动重新开始，需要用户反复的进行操作才能把所有的数据同步完。</li>
<li>退出登录的时候，居然<strong>真的</strong>把用户的数据删除了。</li>
</ul>
<p>综合来看，乐动力这个 App 在这部分上设计得是比较烂的，可能只是一个临时的外包产品的品质。</p>

	
	</div>
  <a type="button" href="/deskangel.github.io/2016/09/30/ledongli-login-issue-workaround/#more" class="btn btn-default more">Read More</a>
</div>

           
		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
        

        <li><a href="/deskangel.github.io/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/deskangel.github.io/page/2/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/deskangel.github.io/categories/Critique/">Critique<span>5</span></a></li>
		
			<li><a href="/deskangel.github.io/categories/Information/">Information<span>8</span></a></li>
		
			<li><a href="/deskangel.github.io/categories/News/">News<span>3</span></a></li>
		
			<li><a href="/deskangel.github.io/categories/Programming/">Programming<span>38</span></a></li>
		
			<li><a href="/deskangel.github.io/categories/Software/">Software<span>35</span></a></li>
		
			<li><a href="/deskangel.github.io/categories/Source/">Source<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/categories/Uncategorized/">Uncategorized<span>0</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/deskangel.github.io/tags/egret/">egret<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/cocos2d/">cocos2d<span>2</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/vs/">vs<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/ibus/">ibus<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/java/">java<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/ubuntu/">ubuntu<span>4</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/game/">game<span>3</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/android/">android<span>10</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/blockchain/">blockchain<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/Android/">Android<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/openpgp/">openpgp<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/deskangel/">deskangel<span>3</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/taskbar/">taskbar<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/dafileserver/">dafileserver<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/dual-view/">dual view<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/regular-expression/">regular expression<span>2</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/daysanddate/">daysanddate<span>4</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/sftp/">sftp<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/charles/">charles<span>1</span></a></li>
		
			<li><a href="/deskangel.github.io/tags/pomelo/">pomelo<span>1</span></a></li>
		
		
		   <li><a href="/tags">...<span>66</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/deskangel.github.io/2020/04/20/dafileserver-dev-notes/" ><i class="fa fa-file-o"></i>DaFileShare 开发笔记</a>
      </li>
    
      <li>
        <a href="/deskangel.github.io/2018/10/24/vsc-with-gdb-remote/" ><i class="fa fa-file-o"></i>vsc-with-gdb-remote</a>
      </li>
    
      <li>
        <a href="/deskangel.github.io/2018/03/31/build-eos-on-ubuntu-16-04/" ><i class="fa fa-file-o"></i>Build EOS on ubuntu 16.04</a>
      </li>
    
      <li>
        <a href="/deskangel.github.io/2017/09/21/custom-eui-control-in-egret/" ><i class="fa fa-file-o"></i>custom-eui-control-in-egret</a>
      </li>
    
      <li>
        <a href="/deskangel.github.io/2016/09/30/ledongli-login-issue-workaround/" ><i class="fa fa-file-o"></i>乐动力“网络不给力”问题的处理</a>
      </li>
    
  </ul>
</div>

		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->


	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2020 William Hsueh
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/deskangel.github.io/js/jquery.imagesloaded.min.js"></script>
<script src="/deskangel.github.io/js/gallery.js"></script>
<script src="/deskangel.github.io/js/bootstrap.min.js"></script>
<script src="/deskangel.github.io/js/main.js"></script>
<script src="/deskangel.github.io/js/search.js"></script> 


<link rel="stylesheet" href="/deskangel.github.io/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/deskangel.github.io/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/deskangel.github.io/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
